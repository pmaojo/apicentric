twin:
  name: gps-tracker
  physics:
    - variable: tick
      strategy: script
      params:
        script: |
          value + 1.0

    - variable: lat
      strategy: script
      params:
        script: |
          let center = 40.7128;
          let radius = 0.005;
          let t = 0.0;
          if "tick" in state { t = state.tick; }
          center + radius * sin(t * 0.05)

    - variable: lon
      strategy: script
      params:
        script: |
          let center = -74.0060;
          let radius = 0.005;
          let t = 0.0;
          if "tick" in state { t = state.tick; }
          center + radius * cos(t * 0.05)

    - variable: speed
      strategy: script
      params:
        script: |
          let t = 0.0;
          if "tick" in state { t = state.tick; }
          // Oscillate speed between 50 and 70
          60.0 + 10.0 * sin(t * 0.2)

    - variable: heading
      strategy: script
      params:
        script: |
          let t = 0.0;
          if "tick" in state { t = state.tick; }
          // Tangent to circle
          (t * 0.05 * 180.0 / 3.14159) % 360.0

    - variable: battery
      strategy: script
      params:
        script: |
          // Drain battery slowly, reset if empty or uninitialized (0.0)
          if value <= 0.0 { 100.0 } else { value - 0.01 }

    - variable: telemetry
      strategy: script
      params:
        script: |
          let lat = 0.0; if "lat" in state { lat = state.lat; }
          let lon = 0.0; if "lon" in state { lon = state.lon; }
          let speed = 0.0; if "speed" in state { speed = state.speed; }
          let heading = 0.0; if "heading" in state { heading = state.heading; }
          let batt = 100.0; if "battery" in state { batt = state.battery; }

          `{"lat": ${lat}, "lon": ${lon}, "speed": ${speed}, "heading": ${heading}, "battery": ${batt}, "status": "moving"}`

  transports:
    - type: mqtt
      broker_url: localhost
      port: 1883
      topic_prefix: vehicle/v123
      subscriptions: []
